<div class="generic-form" *ngIf="!isLoading">
    <h3 class="title">{{ readonlyMode ? 'Visualizza' : 'Modifica' }} {{ companyForm.value.name }}</h3>

    <nav class="tabs">
        <button type="button" [class.active]="activeTab === 'info'" (click)="activeTab = 'info'">Info</button>
        <button type="button" [class.active]="activeTab === 'plan'" (click)="activeTab = 'plan'">Plan</button>
        <button type="button" [class.active]="activeTab === 'monitoring'" (click)="activeTab = 'monitoring'">Monitoring
            user</button>
        <button type="button" [class.active]="activeTab === 'social-media'" (click)="activeTab = 'social-media'">Social
            Media</button>

    </nav>

    <form [formGroup]="companyForm" (ngSubmit)="modifyCompany()">

        <!-- Info Tab -->
        <div *ngIf="activeTab === 'info'" class="tab-content">
            <div class="form-grid">
                <div class="form-group col-50">
                    <label>Nome</label>
                    <input type="text" formControlName="name" />
                </div>
                <div class="form-group col-50">
                    <label>Partita IVA</label>
                    <input type="text" formControlName="vatNumber" />
                </div>
                <div class="form-group col-100">
                    <label>Indirizzo Legale</label>
                    <input type="text" formControlName="legalAddress" />
                </div>
                <div class="form-group col-33">
                    <label>Email PEC</label>
                    <input type="email" formControlName="pecEmail" />
                </div>
                <div class="form-group col-33">
                    <label>Settore</label>
                    <input type="text" formControlName="industry" />
                </div>
                <div class="form-group col-33">
                    <label>Dipendenti</label>
                    <input type="number" formControlName="numberOfEmployees" />
                </div>
                <div class="form-group col-50">
                    <label>Contatto Marketing</label>
                    <input type="text" formControlName="marketingContactName" />
                </div>
                <div class="form-group col-50">
                    <label>Email Marketing</label>
                    <input type="email" formControlName="marketingContactEmail" />
                </div>
                <div class="form-group col-100">
                    <label>Note</label>
                    <textarea formControlName="notes" rows="3"></textarea>
                </div>
            </div>
        </div>

        <!-- Plan Tab -->
        <div *ngIf="activeTab === 'plan'" class="tab-content">
            <div class="form-group col-100">
                <label>Piano Attivo</label>
                <div class="plan-cards">
                    <div *ngFor="let plan of plans" class="plan-card"
                        [class.selected]="plan.id === companyForm.value.planId" (click)="selectPlan(plan.id)">
                        <h4>{{ plan.name }}</h4>
                        <p class="description">{{ plan.description || 'Nessuna descrizione' }}</p>
                        <p><strong>Prezzo:</strong> {{ plan.price | currency:'EUR':'symbol' }} / {{ plan.billingCycle }}
                        </p>
                        <p><strong>Email mensili:</strong> {{ plan.monthlyEmailLimit | number }}</p>
                        <p><strong>Utenti max:</strong> {{ plan.maxUsers }}</p>
                        <p *ngIf="plan.supportLevel"><strong>Supporto:</strong> {{ plan.supportLevel }}</p>
                        <p *ngIf="plan.storageLimitMB"><strong>Storage:</strong> {{ plan.storageLimitMB }} MB</p>
                        <p *ngIf="plan.socialMediaAccountsLimit"><strong>Account social:</strong> {{
                            plan.socialMediaAccountsLimit }}</p>
                        <p *ngIf="plan.googleAdsBudgetLimit"><strong>Budget Google Ads:</strong> {{
                            plan.googleAdsBudgetLimit | currency:'EUR' }}</p>
                        <p *ngIf="plan.googleAdsCampaignLimit"><strong>Campagne Google Ads:</strong> {{
                            plan.googleAdsCampaignLimit }}</p>
                        <p><strong>Prova gratuita:</strong> {{ plan.trialDays }} giorni</p>
                        <p><strong>Stato:</strong>
                            <span [class.active]="plan.active" [class.inactive]="!plan.active">
                                {{ plan.active ? 'Attivo' : 'Non attivo' }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring user Tab -->
        <div *ngIf="activeTab === 'monitoring'" class="tab-content">
            <div class="form-group col-100">
                <div class="monitoring-panel">
                    <div class="user-list">
                        <h4>Utenti Monitoring Disponibili</h4>
                        <ul>
                            <li *ngFor="let user of usersMonitoring" (click)="assignUser(user)" tabindex="0"
                                role="button" [attr.aria-label]="'Assegna ' + user.name + ' a monitoring'">
                                {{ user.name }} ({{ user.email }})
                            </li>
                            <li *ngIf="usersMonitoring.length === 0" class="empty">Nessun utente disponibile</li>
                        </ul>
                    </div>

                    <div class="user-list">
                        <h4>Utenti Monitoring Assegnati</h4>
                        <ul>
                            <li *ngFor="let user of assignedUsers" (click)="removeUser(user)" tabindex="0" role="button"
                                [attr.aria-label]="'Rimuovi ' + user.name + ' da monitoring'">
                                {{ user.name }} ({{ user.email }})
                            </li>
                            <li *ngIf="assignedUsers.length === 0" class="empty">Nessun utente assegnato</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Social Media Tab -->
        <div *ngIf="activeTab === 'social-media'" class="tab-content">
            <div class="accordion-wrapper">

                <!-- META -->
                <div class="accordion-item">
                    <div class="accordion-header" (click)="toggleAccordion('meta')">
                        <h4>Meta (FB, IG , Whatsapp)</h4>
                        <div>
                            <strong>Scadenza token:</strong>
                            <span [ngClass]="{ 'expired': isExpired(metaTokenData?.data_access_expires_at) }">
                                {{ dataAccessExpiresAtDate }}
                                <span
                                    *ngIf="metaTokenData?.data_access_expires_at && !isExpired(metaTokenData?.data_access_expires_at)">
                                    ({{ getTimeLeft(metaTokenData?.data_access_expires_at) }} giorni rimanenti)
                                </span>
                            </span>
                        </div>
                        <div class="actions">
                            <span class="status-label" [ngClass]="getStatusClass(syncStatus['meta'])">
                                {{ getStatusText(syncStatus['meta']) }}
                            </span>
                        </div>
                    </div>

                    <div *ngIf="opened['meta']" class="accordion-body social-block meta-block">

                        <div class="form-group col-100 instructions">
                            <p>
                                <strong>Per far funzionare il collegamento automatico:</strong>
                            </p>
                            <ol style="text-align: left; margin-left: 20px;">
                                <li>Vai su <a href="https://developers.facebook.com/apps" target="_blank" style="color: #4267B2;">Facebook Developers</a></li>
                                <li>Seleziona la tua app (App ID: {{ companyForm.get('metaAppId')?.value || environment.metaAppId }})</li>
                                <li>Vai su <strong>Roles ‚Üí Test Users</strong> o <strong>Roles ‚Üí Administrators</strong></li>
                                <li>Aggiungi il tuo account come <strong>Administrator</strong> o <strong>Developer</strong></li>
                                <li>Poi clicca sul pulsante qui sotto per collegarti</li>
                            </ol>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button type="button" class="btn-connect-meta" (click)="loginWithFacebook()">
                                üîó Collega Facebook
                            </button>
                            
                            <button type="button" class="btn-connect-meta" (click)="testFacebookPages()" 
                                    style="background-color: #42a5f5;">
                                üîç Test Pagine
                            </button>
                        </div>



                        <div class="form-group col-100">
                            <label>META Access Token</label>
                            <input type="text" formControlName="metaAccessToken" readonly 
                                   placeholder="Generato automaticamente dopo il collegamento" />
                        </div>
                        
                        <div class="form-group col-50 instructions">
                            <p>
                                Dopo aver cliccato "Collega Facebook", seleziona una pagina dalla lista qui sotto.
                            </p>
                        </div>
                        <div class="form-group col-100">
                            <label for="pageSelect">Seleziona una pagina Facebook:</label>

                            <select id="pageSelect" class="form-control" formControlName="metaPageId"
                                (change)="onPageSelect()">
                                <option [ngValue]="undefined" disabled>-- Seleziona Pagina --</option>
                                <option *ngFor="let page of metaPageData;" [ngValue]="page.id">
                                    {{ page.name }} ({{ page.id }})
                                </option>
                            </select>
                            
                            <div *ngIf="metaPageData && metaPageData.length === 0" style="color: #f44336; margin-top: 10px;">
                                ‚ö†Ô∏è Nessuna pagina trovata. Possibili cause:
                                <ul>
                                    <li>Essere amministratore di almeno una pagina Facebook</li>
                                    <li>Aver accettato tutti i permessi durante il login</li>
                                    <li>Cliccare sul pulsante "üîç Test Pagine Facebook" per verificare</li>
                                </ul>
                            </div>
                        </div>

                        <div class="form-group col-100">
                            <label>META Page Access Token</label>
                            <input type="text" formControlName="metaPageAccessToken" />
                        </div>
                        <div class="form-group col-100">
                            <label>META PageId</label>
                            <input type="text" formControlName="metaPageId" />
                        </div>
                        <div class="form-group col-50">
                            <div *ngIf="metaTokenData" class="meta-token-info">
                                <h2>Informazioni Token Meta</h2>

                                <p><strong>Applicazione:</strong> {{ metaTokenData.application }}</p>
                                <p><strong>User ID:</strong> {{ metaTokenData.user_id }}</p>
                                <p><strong>App ID:</strong> {{ metaTokenData.app_id }}</p>
                                <p><strong>Tipo:</strong> {{ metaTokenData.type }}</p>
                                <p>
                                    <strong>Token valido:</strong>
                                    <span
                                        [ngClass]="{ 'valid': metaTokenData.is_valid, 'invalid': !metaTokenData.is_valid }">
                                        {{ metaTokenData.is_valid ? 'S√¨' : 'No' }}
                                    </span>
                                </p>
                                <p>
                                    <strong>Scadenza Token:</strong>
                                    <span *ngIf="metaTokenData.expires_at !== 0; else noExpiry"
                                        [ngClass]="{ 'expired': isExpired(metaTokenData.expires_at) }">
                                        {{ expiresAtDate }}
                                    </span>
                                    <ng-template #noExpiry>
                                        Nessuna scadenza
                                    </ng-template>
                                </p>

                                <p>
                                    <strong>Scadenza accesso ai dati:</strong>
                                    <span [ngClass]="{ 'expired': isExpired(metaTokenData.data_access_expires_at) }">
                                        {{ dataAccessExpiresAtDate }}
                                    </span>
                                </p>

                                <h3>Permessi Attivi (Scopes):</h3>
                                <ul>
                                    <li *ngFor="let scope of metaTokenData.scopes">{{ scope }}</li>
                                </ul>

                                <h3>Permessi Granulari:</h3>
                                <div *ngFor="let g of metaTokenData.granular_scopes" class="granular-scope">
                                    <strong>{{ g.scope }}</strong>
                                    <div *ngIf="g.target_ids">
                                        <em>Target IDs:</em> {{ g.target_ids.join(', ') }}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>


                <!-- TIKTOK -->
                <div class="accordion-item">
                    <div class="accordion-header" (click)="toggleAccordion('tiktok')">
                        <h4>TikTok</h4>
                        <div class="actions">
                            <span class="status-label" [ngClass]="getStatusClass(syncStatus['tiktok'])">
                                {{ getStatusText(syncStatus['tiktok']) }}
                            </span>

                        </div>
                    </div>
                    <div *ngIf="opened['tiktok']" class="accordion-body social-block tiktok-block">
                        <div class="form-group col-50">
                            <label>TikTok Link</label>
                            <input type="url" formControlName="tiktokLink" placeholder="https://tiktok.com/..." />
                        </div>
                        <div class="form-group col-50">
                            <label>TikTok Business ID</label>
                            <input type="text" formControlName="tiktokBusinessId" />
                        </div>
                        <div class="form-group col-100">
                            <label>TikTok Access Token</label>
                            <input type="text" formControlName="tiktokAccessToken" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="buttons" *ngIf="activeTab !== 'social-media'">
            {{ readonlyMode ? '' : ' '}}
            <div *ngIf="!readonlyMode" class="buttons">
                <button type="submit" class="btn-primary" [disabled]="companyForm.invalid">Salva modifiche</button>
            </div>
        </div>

    </form>
</div>