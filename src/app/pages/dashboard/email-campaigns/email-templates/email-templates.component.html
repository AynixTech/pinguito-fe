<div class="templates-container">
  <div class="header">
    <h1>
      <i class="fas fa-file-code"></i>
      Template Email
      <span class="company-badge" *ngIf="companyName">
        <i class="fas fa-building"></i> {{ companyName }}
      </span>
    </h1>
    <div class="header-actions">
      <button class="btn btn-ai" (click)="openAiDialog()">
        <i class="fas fa-magic"></i>
        Genera con AI
      </button>
      <button class="btn btn-primary" (click)="openCreateForm()">
        <i class="fas fa-plus"></i>
        Nuovo Template
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-box" *ngIf="!showCreateForm">
    <i class="fas fa-search"></i>
    <input 
      type="text" 
      [(ngModel)]="searchTerm" 
      (input)="filterTemplates()"
      placeholder="Cerca template per nome o oggetto...">
  </div>

  <!-- Templates List -->
  <div class="templates-grid" *ngIf="!showCreateForm">
    <div class="template-card" *ngFor="let template of filteredTemplates">
      <div class="template-header">
        <h3>{{ template.name }}</h3>
        <div class="template-actions">
          <button class="btn-icon" (click)="openEditForm(template)" title="Modifica">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon" (click)="duplicateTemplate(template)" title="Duplica">
            <i class="fas fa-copy"></i>
          </button>
          <button class="btn-icon btn-delete" (click)="deleteTemplate(template.uuid!)" title="Elimina">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="template-subject">
        <strong>Oggetto:</strong> {{ template.subject }}
      </div>

      <div class="template-preview" [innerHTML]="template.htmlContent"></div>

      <div class="template-meta">
        <span *ngIf="template.variables && template.variables.length > 0">
          <i class="fas fa-tags"></i>
          Variabili: {{ template.variables.join(', ') }}
        </span>
        <span>
          <i class="fas fa-calendar"></i>
          {{ template.createdAt | date: 'dd/MM/yyyy' }}
        </span>
      </div>
    </div>

    <div *ngIf="filteredTemplates.length === 0" class="empty-state">
      <i class="fas fa-file-code"></i>
      <p>Nessun template trovato</p>
      <button class="btn btn-primary" (click)="openCreateForm()">
        Crea il tuo primo template
      </button>
    </div>
  </div>

  <!-- Create/Edit Form -->
  <div class="template-form" *ngIf="showCreateForm">
    <div class="form-header">
      <h2>
        <i class="fas fa-file-code"></i>
        {{ editingTemplate ? 'Modifica Template' : 'Nuovo Template' }}
      </h2>
      <button class="btn-close" (click)="closeForm()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="templateForm">
      <div class="form-row">
        <div class="form-group">
          <label for="name">Nome Template *</label>
          <input 
            type="text" 
            id="name" 
            formControlName="name" 
            placeholder="Es: Newsletter Benvenuto"
            class="form-control">
        </div>

        <div class="form-group">
          <label for="subject">Oggetto Email *</label>
          <input 
            type="text" 
            id="subject" 
            formControlName="subject" 
            placeholder="Es: Benvenuto in Pinguito!"
            class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label for="htmlContent">Contenuto HTML *</label>
        <textarea 
          id="htmlContent" 
          formControlName="htmlContent" 
          (input)="updatePreview()"
          rows="15"
          placeholder="<h1>Ciao {{'{{'}}firstName{{'}}'}}</h1><p>Benvenuto!</p>"
          class="form-control code-editor"></textarea>
        <small>
          Variabili disponibili: {{'{{'}}firstName{{'}}'}}, {{'{{'}}lastName{{'}}'}}, {{'{{'}}company{{'}}'}}, {{'{{'}}email{{'}}'}}
        </small>
      </div>

      <div class="preview-section" *ngIf="previewHtml">
        <h3>Anteprima</h3>
        <div class="preview-box" [innerHTML]="previewHtml"></div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn" (click)="closeForm()">
          Annulla
        </button>
        <button type="button" class="btn btn-primary" (click)="saveTemplate()" [disabled]="!templateForm.valid">
          <i class="fas fa-save"></i>
          {{ editingTemplate ? 'Aggiorna' : 'Crea' }} Template
        </button>
      </div>
    </form>
  </div>
</div>

<!-- AI Generation Dialog -->
<div class="ai-dialog-overlay" *ngIf="showAiDialog" (click)="closeAiDialog()">
  <div class="ai-dialog" (click)="$event.stopPropagation()">
    <div class="ai-dialog-header">
      <div class="header-content">
        <div class="ai-icon-wrapper">
          <i class="fas fa-magic"></i>
        </div>
        <div class="header-text">
          <h2>Genera Template con AI</h2>
          <p>Crea email professionali in pochi secondi usando l'intelligenza artificiale</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeAiDialog()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="ai-dialog-content">
      <!-- Prompt Section -->
      <div class="ai-section">
        <div class="section-header">
          <i class="fas fa-lightbulb"></i>
          <h3>Descrizione del Template</h3>
        </div>
        <div class="form-group">
          <textarea 
            id="aiPrompt" 
            [(ngModel)]="aiPrompt" 
            rows="5"
            placeholder="Esempio: Email di benvenuto per nuovi clienti che si sono registrati al servizio. Include un messaggio caloroso, presenta i principali benefici del servizio e un pulsante call-to-action per iniziare il primo progetto."
            class="form-control ai-textarea"
            [disabled]="generatingAi"></textarea>
          <div class="input-hint">
            <i class="fas fa-info-circle"></i>
            <span>Pi√π dettagli fornisci, migliore sar√† il risultato. Descrivi lo scopo, il pubblico target e gli elementi chiave da includere.</span>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="ai-section">
        <div class="section-header">
          <i class="fas fa-sliders-h"></i>
          <h3>Personalizza Stile</h3>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="aiTone">
              <i class="fas fa-comment-dots"></i>
              Tono di Voce
            </label>
            <select id="aiTone" [(ngModel)]="aiTone" class="form-control select-modern" [disabled]="generatingAi">
              <option value="professional">üéØ Professionale - Formale e affidabile</option>
              <option value="friendly">üòä Amichevole - Casual e accessibile</option>
              <option value="enthusiastic">üéâ Entusiasta - Energico e coinvolgente</option>
              <option value="informative">üìö Informativo - Chiaro e educativo</option>
            </select>
          </div>

          <div class="form-group">
            <label for="aiLength">
              <i class="fas fa-ruler-horizontal"></i>
              Lunghezza Contenuto
            </label>
            <select id="aiLength" [(ngModel)]="aiLength" class="form-control select-modern" [disabled]="generatingAi">
              <option value="short">üìù Breve - 2-3 paragrafi</option>
              <option value="medium">üìÑ Media - 4-5 paragrafi</option>
              <option value="long">üìã Lunga - 6-8 paragrafi</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Features Info -->
      <div class="ai-features">
        <div class="feature-item">
          <i class="fas fa-check-circle"></i>
          <span>HTML ottimizzato per email client</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-check-circle"></i>
          <span>Stili inline responsive</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-check-circle"></i>
          <span>Variabili personalizzabili incluse</span>
        </div>
        <div class="feature-item">
          <i class="fas fa-check-circle"></i>
          <span>Design moderno e professionale</span>
        </div>
      </div>
    </div>

    <div class="ai-dialog-footer">
      <button class="btn btn-secondary" (click)="closeAiDialog()" [disabled]="generatingAi">
        <i class="fas fa-times"></i>
        Annulla
      </button>
      <button class="btn btn-ai-primary" (click)="generateWithAi()" [disabled]="!aiPrompt.trim() || generatingAi">
        <i class="fas fa-spinner fa-spin" *ngIf="generatingAi"></i>
        <i class="fas fa-magic" *ngIf="!generatingAi"></i>
        {{ generatingAi ? 'Generazione in corso...' : 'Genera Template' }}
      </button>
    </div>
  </div>
</div>
