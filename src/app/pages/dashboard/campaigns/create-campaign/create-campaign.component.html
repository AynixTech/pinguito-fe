<div class="generic-form">
    <h2 class="title">Crea una nuova Campagna</h2>

    <form [formGroup]="campaignForm" (ngSubmit)="onSubmit()" class="form-grid">



        <div class="form-group col-100">
            <label for="companyName">Azienda (Nome)</label>
            <input type="text" id="companyName" formControlName="companyName" placeholder="Company Name" [readonly]="true" />
        </div>

        <div class="form-group col-100">
            <label for="companyUuid">Azienda (UUID)</label>
            <input type="text" id="companyUuid" formControlName="companyUuid"
                placeholder="es. 123e4567-e89b-12d3-a456-426614174000" [readonly]="true" />
            <div *ngIf="campaignForm.get('companyUuid')?.touched && campaignForm.get('companyUuid')?.invalid"
                class="form-error">
                UUID obbligatorio.
            </div>
        </div>

        <div class="form-group col-50">
            <label for="name">Nome campagna</label>
            <input type="text" id="name" formControlName="name" placeholder="Campagna Inverno 2025" />
            <div *ngIf="campaignForm.get('name')?.touched && campaignForm.get('name')?.invalid" class="form-error">
                Il nome della campagna è obbligatorio.
            </div>
        </div>

        <div class="form-group col-50">
            <label for="budget">Budget (€)</label>
            <input type="number" id="budget" formControlName="budget" placeholder="1000" />
        </div>

        <div class="form-group col-100">
            <label for="description">Descrizione</label>
            <textarea id="description" formControlName="description"
                placeholder="Campagna inverno con focus su email marketing"></textarea>
        </div>

        <div class="form-group col-50">
            <label for="startDate">Data Inizio</label>
            <input type="datetime-local" id="startDate" formControlName="startDate" />
        </div>

        <div class="form-group col-50">
            <label for="endDate">Data Fine</label>
            <input type="datetime-local" id="endDate" formControlName="endDate" />
            <div *ngIf="campaignForm.errors?.['endBeforeStart'] && (campaignForm.get('endDate')?.touched || campaignForm.get('startDate')?.touched)"
                class="form-error">
                La data di fine deve essere **successiva** alla data di inizio.
            </div>

        </div>

        <div class="form-group col-100">
            <label for="status">Stato</label>
            <select id="status" formControlName="status">
                <option value="planned">Pianificata</option>
                <option value="active">Attiva</option>
                <option value="inactive">Inattiva</option>
                <option value="completed">Completata</option>
                <option value="cancelled">Cancellata</option>
            </select>
        </div>

        <div class="form-group col-50">
            <label for="numberPosts">Numero Post per giorno</label>
            <input type="number" id="numberPosts" formControlName="numberPosts" placeholder="1" />
            <div *ngIf="campaignForm.get('numberPosts')?.touched && campaignForm.get('numberPosts')?.invalid"
                class="form-error">
                Inserisci almeno 1 post al giorno. </div>
        </div>

         <div class="form-group col-50">
            <label for="targetAudience">Target</label>
            <input type="text" id="targetAudience" formControlName="targetAudience" placeholder="es. Giovani adulti 18-25" />
        </div>

        <div class="form-group col-100">
            <label>Canali</label>
            <div class="checkbox-group">
                <label><input type="checkbox" [value]="'email'" (change)="onChannelChange($event)"
                        [checked]="channels.includes('email')" /> Email</label>
                <label><input type="checkbox" [value]="'facebook'" (change)="onChannelChange($event)"
                        [checked]="channels.includes('facebook')" /> Facebook</label>
                <label><input type="checkbox" [value]="'instagram'" (change)="onChannelChange($event)"
                        [checked]="channels.includes('instagram')" /> Instagram</label>
                <label><input type="checkbox" [value]="'tiktok'" (change)="onChannelChange($event)"
                        [checked]="channels.includes('tiktok')" /> TikTok</label>
            </div>
        </div>


        <hr />
        <!-- Campo prompt AI -->
        <div class="form-group col-100">
            <label for="aiContentPrompt">Prompt Contenuto AI</label>
            <textarea id="aiContentPrompt" formControlName="aiContentPrompt"
                placeholder="es. 'Scrivi un testo promozionale per una campagna invernale di email marketing rivolto a clienti fidelizzati'"></textarea>
            <div *ngIf="campaignForm.get('aiContentPrompt')?.touched && campaignForm.get('aiContentPrompt')?.invalid"
                class="form-error">
                Inserisci un prompt valido per generare il contenuto AI. </div>
        </div>

       

       

        <div class="form-group col-50">
            <label for="generateAiImages">Genera Immagini AI</label>
            <input type="checkbox" id="generateAiImages" formControlName="generateAiImages" />
        </div>

        <div class="form-group col-100">
            <button type="button" class="btn-generate-ai-content" (click)="generateAIContent()"
                [disabled]="!campaignForm.get('aiContentPrompt')?.value.trim() || channels.length === 0">
                Genera contenuto AI
            </button>
        </div>
        <!-- Campi AI generati -->
        <div class="form-group col-100">
            <div class="post-container" *ngIf="channels.includes('facebook')" formArrayName="facebookPosts">
                <h3 class="section-title">
                    <i class="fab fa-facebook"></i> Post Facebook ({{ facebookPosts.controls.length }})
                </h3>
                
                <div class="posts-grid">
                    <div class="post-card" *ngFor="let post of facebookPosts.controls; let i = index" [formGroupName]="i">
                        <div class="post-header" (click)="togglePost('fb-' + i)">
                            <h4>
                                <i class="fas fa-calendar-alt"></i>
                                Post {{ i + 1 }}
                                <span class="post-date" *ngIf="post.get('scheduledDate')?.value">
                                    - {{ post.get('scheduledDate')?.value | date:'dd/MM/yyyy HH:mm' }}
                                </span>
                            </h4>
                            <div class="post-actions">
                                <button class="btn-icon btn-remove" type="button" (click)="removeFacebookPost(i); $event.stopPropagation()" title="Rimuovi">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                <i class="fas" [ngClass]="isPostExpanded('fb-' + i) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                            </div>
                        </div>

                        <div class="post-body" [class.expanded]="isPostExpanded('fb-' + i)">
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Contenuto</label>
                                    <textarea formControlName="aiGeneratedContent" rows="4"></textarea>
                                </div>
                            </div>

                            <div class="form-row two-cols">
                                <div class="form-field">
                                    <label>Sintesi</label>
                                    <textarea formControlName="aiSummary" rows="2"></textarea>
                                </div>
                                <div class="form-field">
                                    <label>Parole Chiave</label>
                                    <input formControlName="aiKeywords" type="text" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label>Data Programmazione</label>
                                    <input formControlName="scheduledDate" type="datetime-local" />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-field">
                                    <label>Immagine</label>
                                    <div class="image-upload-container">
                                        <input 
                                            type="file" 
                                            #fileInput
                                            accept="image/*"
                                            (change)="onFileSelected($event, i)"
                                            style="display: none"
                                        />
                                        
                                        <button 
                                            type="button" 
                                            class="btn-upload"
                                            (click)="fileInput.click()"
                                            *ngIf="!post.get('imageUrl')?.value"
                                        >
                                            <i class="fas fa-image"></i> Sfoglia immagine
                                        </button>
                                        
                                        <div class="image-preview" *ngIf="post.get('imageUrl')?.value">
                                            <img [src]="post.get('imageUrl')?.value" alt="Preview" />
                                            <div class="image-actions">
                                                <button 
                                                    type="button" 
                                                    class="btn-change-image"
                                                    (click)="fileInput.click()"
                                                    title="Cambia immagine"
                                                >
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                <button 
                                                    type="button" 
                                                    class="btn-remove-image"
                                                    (click)="removeImage(i)"
                                                    title="Rimuovi immagine"
                                                >
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn-add-post" type="button" (click)="addFacebookPost()">
                    <i class="fas fa-plus"></i> Aggiungi post Facebook
                </button>
            </div>
        </div>
        <div class="buttons col-100">
            <button class="btn-primary" type="button" (click)="onSubmit()">Crea campagna</button>
        </div>
    </form>
</div>